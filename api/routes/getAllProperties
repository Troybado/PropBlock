var express = require("express");
require("dotenv").config();
var Moralis = require("../modules/moralis");
var config = require('../config');
var helper = require("../functions/Helper");

var router = express.Router();

//getting all properties from Moralis
router.get("/getAllProperties", async function(req, res, next) {
    const query = new Moralis.Query("PropertiesAdded");
    const pageNumber = parseInt(req.query.pageNumber) || 1;
    query.skip(config.pageSize * (pageNumber - 1))
    query.limit(config.pageSize)
    query.withCount()
    const _result = await query.find();
    const result = JSON.parse(JSON.stringify(_result))
    for (var i = 0; i < result.results.length; i++) {
        console.log("getting for " + result.results[i].transaction_hash)
        var extraDetails = await helper.getPropertyExtraDetails(result.results[i].transaction_hash)
        var images = {images: await helper.getImages(result.results[i].ipfsHash)}
        Object.assign(result.results[i], result.results[i], extraDetails, images)
    }
    result.totalPages = helper.getTotalPageNumbers(result.count, config.pageSize)
    res.json(result)

});

module.exports = router;