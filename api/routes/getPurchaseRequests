var express = require("express");
require("dotenv").config();
var Moralis = require("../modules/moralis");
var config = require("../config");
var helper = require("../functions/Helper");

var router = express.Router();

//getting purchases requests for a seller
router.get("/getPurchaseRequests", async function (req, res, next) {
  const sessionToken = req.query.sessionToken;
  var isLoggedIn = await helper.isAuthenticated(sessionToken)
  if (!isLoggedIn) {
    res.status(401);
    res.send("not authenticated")
    return;
  }

  const ownerAddress = req.query.ownerAddress.toLowerCase();
  if (ownerAddress) {

    const requestsQuery = new Moralis.Query("PurchaseRequest");
    requestsQuery.equalTo("sellerEthAddress", ownerAddress);
    requestsQuery.equalTo("isPending", true)
    const requestResult = await requestsQuery.find();

     //because moralis object is very bad
     //so ill just treat it as a JSON
    const result = JSON.parse(JSON.stringify(requestResult))
    // console.log("total result: " + result.length)
    
    const data = [];
    for (let i = 0; i < result.length; i++) {
      var currentResult = result[i];
      console.log(currentResult)
      //only return results with isBeingProcessed status

      var inCache = false;
      var user = {};
      var requestorAddress = currentResult.requesterEthAddress;

      //make local caching
      var inCache = false;
      var user = {};

      for (var j = 0; j < data.length; j++) {
        //if user exists in cache
        if (data[j]["address"] == requestorAddress) {
          inCache = true;
          user = {
            fullName: data[j]["fullName"],
            address: data[j]["address"]
          }
          break;
        }
      }

      if (!inCache) user = await helper.getUser(requestorAddress);
      
      data.push({
        id: currentResult.objectId,
        fullName: user.fullName,
        address: user.address,
        isAccepted: currentResult.isAccepted,
        isPending: currentResult.isPending ?? true,
        createdAt: currentResult.createdAt,
        propertyObjectId: currentResult.propertyObjectId
      });
    }
    res.send(data);
    }
});

module.exports = router;
